<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Names - Navbar & Speed Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { 
            --primary-blue: #5ba3f5; 
            --soft-blue: #e6f4ff;    
            --text-main: #2d3748;    
            --nav-dark: #0f172a; 
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            margin: 0; padding: 0; color: var(--text-main);
            min-height: 100vh;
            background: linear-gradient(135deg, #e3f2fd 0%, #fce4ec 100%);
            background-attachment: fixed;
        }

        /* --- NAVBAR STYLING --- */
        .navbar {
            width: 100%;
            background-color: var(--nav-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 40px;
            box-sizing: border-box;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-size: 22px;
            font-weight: 800;
            color: #f1c40f;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #ffffff;
            transition: 0.2s;
            user-select: none;
        }
        .nav-item:hover { opacity: 0.8; }
        .nav-item input[type="checkbox"] { cursor: pointer; width: 17px; height: 17px; }

        .duration-box {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 5px 12px;
            border-radius: 8px;
        }
        .duration-input {
            width: 45px;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: 700;
            color: #f1c40f;
            outline: none;
            font-size: 15px;
        }

        /* --- MAIN LAYOUT --- */
        .main-container { display: flex; gap: 40px; flex-wrap: wrap; justify-content: center; max-width: 1300px; width: 100%; margin-top: 30px; padding-bottom: 50px; }
        
        .wheel-section { 
            position: relative; width: 700px; height: 700px; 
            filter: drop-shadow(0 20px 50px rgba(0,0,0,0.08));
        }
        
        #canvas { background: white; border-radius: 50%; border: 12px solid #ffffff; cursor: pointer; }
        
        #pointer { 
            position: absolute; top: 50%; right: -25px; transform: translateY(-50%);
            width: 0; height: 0; border-top: 25px solid transparent; border-bottom: 25px solid transparent; 
            border-right: 45px solid #334155; z-index: 10;
        }

        .controls-section { 
            width: 380px; background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #e1f5fe;
            backdrop-filter: blur(8px);
        }
        .controls-section.hidden-mode { display: none; }

        .tabs-header { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .tab-item { cursor: pointer; font-weight: 600; color: #94a3b8; display: flex; align-items: center; gap: 8px; padding: 8px 0; transition: 0.3s; }
        .tab-item.active { color: var(--primary-blue); border-bottom: 2px solid var(--primary-blue); }
        .tab-count { background: #cbd5e1; color: white; border-radius: 6px; padding: 2px 8px; font-size: 11px; font-weight: 700; }

        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .btn-blue { 
            background: var(--primary-blue); color: white; border: none; padding: 12px; 
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px; 
            transition: all 0.2s; box-shadow: 0 4px 12px rgba(0, 149, 255, 0.2);
        }
        .btn-blue:hover:not(:disabled) { background: #0076cc; transform: translateY(-2px); }
        .btn-blue:disabled { background: #cbd5e1; cursor: not-allowed; opacity: 0.6; }

        #namesInput, #resultsList { 
            height: 450px; padding: 15px; border-radius: 12px; border: 1px solid #e1f5fe; 
            overflow-y: auto; outline: none; background: linear-gradient(135deg, #fafafa, #fef7ff); font-size: 18px; 
            color: var(--text-main); line-height: 1.6;
        }

        .auto-remove-container {
            margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #e3f2fd, #fce4ec); border-radius: 12px; 
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;
        }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: white; width: 500px; border-radius: 24px; overflow: hidden; }
        .modal-header { background: white; color: var(--text-main); padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .modal-body { padding: 25px; text-align: center; max-height: 500px; overflow-y: auto; }
        .modal-footer { padding: 15px 25px; background: linear-gradient(135deg, #e3f2fd, #fce4ec); display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #e1f5fe; }
        .option-card { border: 1px solid #e2e8f0; padding: 15px; margin-bottom: 12px; cursor: pointer; border-radius: 14px; transition: 0.2s; font-weight: 600; text-align: left; background: white; }
        .gallery-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; }
        .gallery-item { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 12px; cursor: pointer; border: 3px solid transparent; }
        .gallery-item.selected { border-color: var(--primary-blue); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 14px 28px; border-radius: 12px; display: none; align-items: center; gap: 15px; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.2); font-size: 14px; }
        img.list-img { height: 50px; width: 50px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; display: block; }
        #fileInput { display: none; }
        #displayWinnerName { font-size: 48px !important; color: var(--primary-blue) !important; margin: 10px 0; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-logo">üé° WHEEL OF NAMES</div>
        
        <div class="nav-links">
            <div class="nav-item" onclick="createNewWheel()">
                <span>üìÑ</span> Baru
            </div>
            <div class="nav-item">
                <input type="checkbox" id="hideArea" onchange="toggleHide()"> 
                <label for="hideArea" style="cursor:pointer">Sembunyikan Editor</label>
            </div>
            <div class="nav-item duration-box">
                <span>‚è±Ô∏è</span>
                <input type="number" id="spinDuration" class="duration-input" value="4.5" step="0.5" min="1">
                <span>detik</span>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div class="wheel-section">
            <div id="pointer"></div>
            <canvas id="canvas" width="700" height="700" onclick="handleSpinClick()"></canvas>
        </div>

        <div class="controls-section" id="mainControls">
            <div class="tabs-header">
                <div class="tab-item active" id="tabEntries" onclick="switchTab('entries')">Entries <span class="tab-count" id="countEntries">0</span></div>
                <div class="tab-item" id="tabResults" onclick="switchTab('results')">Results <span class="tab-count" id="countResults">0</span></div>
            </div>
            
            <div id="entriesButtons">
                <div class="button-grid">
                    <button id="btnShuffle" class="btn-blue" onclick="shuffleItems()">üîÄ Shuffle</button>
                    <button id="btnSort" class="btn-blue" onclick="sortItems()">‚¨ÜÔ∏è Sort A-Z</button>
                </div>
                <button id="btnCust" class="btn-blue" style="width:100%; margin-bottom:10px; background: linear-gradient(135deg, #fce4ec, #f8bbd9); color: #c2185b; border: 1px dashed #f06292; box-shadow: none;" onclick="if(!isSpinning) document.getElementById('modalType').style.display='flex'">üé® Customize Wheel</button>
                
                <div class="auto-remove-container">
                    <span style="font-size: 13px; font-weight: 600; color: #475569;">Auto-remove winner</span>
                    <input type="checkbox" id="autoRemoveToggle">
                </div>
            </div>

            <div id="resultsButtons" style="display:none">
                <button id="btnClear" class="btn-blue" style="background:#fee2e2; color:#ef4444; width:100%; margin-bottom:10px;" onclick="clearResults()">üóëÔ∏è Clear Data</button>
            </div>

            <div id="namesInput" contenteditable="true" oninput="syncFromVisual()">Akbar<br>Budi<br>Sarah<br>Dinda</div>
            <div id="resultsList" style="display:none"></div>
        </div>
    </div>

    <div id="toast" class="toast"><span id="toastMsg"></span></div>

    <div id="modalType" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Select Target</h3><span onclick="closeModals()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body">
                <div class="option-card" onclick="goToStep2('bg')">üñºÔ∏è Add Wheel Background</div>
                <div class="option-card" onclick="goToStep2('center')">üéØ Add Center Logo</div>
                <div class="option-card" onclick="goToStep2('entry')">üçï Add Image Entry</div>
            </div>
        </div>
    </div>

    <div id="modalSource" class="modal-overlay">
        <div class="modal-content" style="width: 550px;">
            <div class="modal-header"><h3>Select Image</h3><span onclick="closeModals()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body">
                <div class="option-card" onclick="triggerFileUpload()" style="border-style: dashed; text-align: center; background: #fafafa;">üì§ Upload from Device</div>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModals()" style="background:none; border:none; cursor:pointer; color:#64748b; font-weight:600;">Cancel</button>
                <button class="btn-blue" style="width:auto; margin:0; padding: 8px 25px;" onclick="confirmGallerySelection()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="winnerModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h3>Winner!</h3><span onclick="closeWin()" style="cursor:pointer; font-size:24px">&times;</span></div>
            <div class="modal-body">
                <div id="winnerImgContainer"></div>
                <p id="displayWinnerName"></p>
            </div>
            <div class="modal-footer" id="winnerFooter"></div>
        </div>
    </div>

    <input type="file" id="fileInput" accept="image/*">
    <audio id="tickSound"><source src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" type="audio/mpeg"></audio>
    <audio id="winSound"><source src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3" type="audio/mpeg"></audio>

    <script>
        const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
        const namesInput = document.getElementById('namesInput'), resultsList = document.getElementById('resultsList');
        const tickSound = document.getElementById('tickSound'), winSound = document.getElementById('winSound');
        const toast = document.getElementById('toast'), toastMsg = document.getElementById('toastMsg');
        const pointerEl = document.getElementById('pointer');
        const colors = ['#d50f25', '#eeb211', '#009925', '#3369e8'];
        
        let items = [], resultsArr = [], currentRotation = 0, isSpinning = false, lastWinnerIdx = -1;
        let wheelBg = null, centerLogo = null, activeTarget = '', selectedGalleryUrl = null;
        let idleAnimationFrame = null, hasBeenSpun = false; 

        const abstractImages = ["https://images.unsplash.com/photo-1541701494587-cb58502866ab?w=200", "https://images.unsplash.com/photo-1557683316-973673baf926?w=200", "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?w=200", "https://images.unsplash.com/photo-1508615039623-a25605d2b022?w=200", "https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=200", "https://images.unsplash.com/photo-1550684848-fac1c5b4e853?w=200", "https://images.unsplash.com/photo-1511447333015-45b65e60f6d5?w=200", "https://images.unsplash.com/photo-1558591710-4b4a1ae0f04d?w=200"];

        function showToast(msg) { toastMsg.innerText = msg; toast.style.display = 'flex'; setTimeout(() => { toast.style.display = 'none'; }, 3000); }

        function createNewWheel() {
            if(isSpinning) return;
            if(confirm("Buat roda baru? Semua data akan dihapus.")) {
                namesInput.innerHTML = "Nama 1<br>Nama 2<br>Nama 3";
                resultsArr = [];
                updateResultsUI();
                syncFromVisual();
                hasBeenSpun = false;
                startIdleSpin();
            }
        }

        function syncFromVisual() {
            if(isSpinning) return;
            let newItems = [];
            const temp = document.createElement('div');
            temp.innerHTML = namesInput.innerHTML.replace(/<div>/g, "\n").replace(/<\/div>/g, "").replace(/<br>/g, "\n");
            Array.from(temp.childNodes).forEach(node => {
                if(node.nodeName === "IMG") {
                    const imgObj = new Image(); imgObj.src = node.src;
                    imgObj.onload = () => drawWheel();
                    newItems.push({ name: "", image: imgObj });
                } else if(node.textContent.trim()) {
                    node.textContent.split('\n').forEach(t => { if(t.trim()) newItems.push({ name: t.trim(), image: null }); });
                }
            });
            items = newItems;
            document.getElementById('countEntries').innerText = items.length;
            drawWheel();
        }

        function drawWheel() {
            ctx.clearRect(0,0,700,700);
            if(items.length === 0) return;
            const sliceSize = (Math.PI*2) / items.length;
            const normRot = (currentRotation % (Math.PI*2));
            let pIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % items.length;
            if(pIdx < 0) pIdx += items.length;
            pointerEl.style.borderRightColor = colors[pIdx % colors.length] || "#ccc";

            ctx.save(); ctx.translate(350,350); ctx.rotate(currentRotation);
            if(wheelBg) {
                ctx.save(); ctx.beginPath(); ctx.arc(0,0,340,0,Math.PI*2); ctx.clip();
                ctx.drawImage(wheelBg, -350,-350,700,700); ctx.restore();
            }
            items.forEach((it, i) => {
                const angle = i * sliceSize;
                if(!wheelBg) {
                    ctx.beginPath(); ctx.fillStyle = colors[i % colors.length]; ctx.moveTo(0,0);
                    ctx.arc(0,0,340,angle,angle+sliceSize); ctx.fill();
                    ctx.strokeStyle="#fff"; ctx.lineWidth = 2; ctx.stroke();
                }
                ctx.save(); ctx.rotate(angle + sliceSize/2);
                if(it.image) {
                    ctx.save(); ctx.beginPath(); ctx.arc(200, 0, 45, 0, Math.PI*2); ctx.clip();
                    ctx.drawImage(it.image, 155, -45, 90, 90); ctx.restore();
                } else if(it.name) {
                    let fontSize = 32; 
                    ctx.font = `bold ${fontSize}px sans-serif`;
                    let textWidth = ctx.measureText(it.name).width;
                    while (textWidth > 240 && fontSize > 8) { fontSize--; ctx.font = `bold ${fontSize}px sans-serif`; textWidth = ctx.measureText(it.name).width; }
                    ctx.textAlign="right"; ctx.fillStyle="#fff"; ctx.fillText(it.name, 320, fontSize/3);
                }
                ctx.restore();
            });
            if(centerLogo) {
                ctx.save(); ctx.beginPath(); ctx.arc(0,0,65,0,Math.PI*2); ctx.clip();
                ctx.drawImage(centerLogo, -65,-65,130,130); ctx.restore();
            }
            ctx.restore();
            if(!centerLogo) {
                ctx.save(); ctx.translate(350,350); ctx.beginPath(); ctx.arc(0,0,55,0,Math.PI*2);
                ctx.fillStyle="white"; ctx.fill(); ctx.fillStyle="#333"; ctx.font="bold 20px sans-serif";
                ctx.textAlign="center"; ctx.fillText("SPIN", 0, 7); ctx.restore();
            }
        }

        function startIdleSpin() {
            if (isSpinning || hasBeenSpun) return;
            currentRotation += 0.005; 
            drawWheel();
            idleAnimationFrame = requestAnimationFrame(startIdleSpin);
        }

        function handleSpinClick() {
            if(isSpinning || items.length === 0) return;
            cancelAnimationFrame(idleAnimationFrame);
            hasBeenSpun = true; 
            isSpinning = true;
            
            // Kunci UI
            namesInput.contentEditable = "false";
            document.getElementById('btnShuffle').disabled = true;
            document.getElementById('btnSort').disabled = true;

            const duration = (parseFloat(document.getElementById('spinDuration').value) || 4.5) * 1000;
            const extra = (Math.PI*2) * (15 + Math.random()*5);
            const startRot = currentRotation, start = performance.now();
            let lastTick = -1;

            function frame(now) {
                const t = Math.min((now-start)/duration, 1);
                const ease = 1 - Math.pow(1-t, 4);
                currentRotation = startRot + extra * ease;
                const currentIdx = Math.floor(((currentRotation % (Math.PI*2))/(Math.PI*2)) * items.length);
                if(currentIdx !== lastTick) { tickSound.currentTime = 0; tickSound.play().catch(()=>{}); lastTick = currentIdx; }
                drawWheel();
                if(t < 1) requestAnimationFrame(frame);
                else { 
                    isSpinning = false; 
                    namesInput.contentEditable = "true";
                    document.getElementById('btnShuffle').disabled = false;
                    document.getElementById('btnSort').disabled = false;
                    winSound.play().catch(()=>{}); 
                    processWinner(); 
                }
            }
            requestAnimationFrame(frame);
        }

        function processWinner() {
            const sliceSize = (Math.PI*2) / items.length;
            const normRot = (currentRotation % (Math.PI*2));
            let winIdx = Math.floor((Math.PI*2 - normRot) / sliceSize) % items.length;
            if(winIdx < 0) winIdx += items.length;
            const win = items[winIdx];
            lastWinnerIdx = winIdx;
            resultsArr.unshift(win); 
            updateResultsUI();
            document.getElementById('displayWinnerName').innerText = win.name || "Winner!";
            document.getElementById('winnerImgContainer').innerHTML = win.image ? `<img src="${win.image.src}" style="width:120px; border-radius:10px; margin-bottom:15px">` : "";
            
            const isAuto = document.getElementById('autoRemoveToggle').checked;
            const footer = document.getElementById('winnerFooter');
            if (isAuto) {
                footer.innerHTML = `<button class="btn-blue" style="width:100%; margin:0;" onclick="closeWin()">OK</button>`;
                setTimeout(() => { items.splice(lastWinnerIdx, 1); writeBack(); }, 500);
            } else {
                footer.innerHTML = `<button onclick="closeWin()" style="background:none; border:none; cursor:pointer; color:#64748b; font-weight:600;">Close</button><button class="btn-blue" style="width:auto; margin:0;" onclick="removeWinner()">Remove Winner</button>`;
            }
            document.getElementById('winnerModal').style.display = 'flex';
            confetti();
        }

        function updateResultsUI() {
            resultsList.innerHTML = "";
            resultsArr.forEach(r => {
                const div = document.createElement('div'); div.style.padding="10px"; div.style.borderBottom="1px solid #eee";
                if(r.image) { const img = r.image.cloneNode(); img.style.height="45px"; div.appendChild(img); }
                else div.innerText = r.name;
                resultsList.appendChild(div);
            });
            document.getElementById('countResults').innerText = resultsArr.length;
        }

        function removeWinner() { items.splice(lastWinnerIdx, 1); writeBack(); closeWin(); showToast("Winner removed!"); }
        function writeBack() { 
            namesInput.innerHTML = ""; 
            items.forEach(it => { 
                if(it.image) { 
                    const wrapper = document.createElement('div'); const img = it.image.cloneNode(); img.className="list-img"; 
                    wrapper.appendChild(img); namesInput.appendChild(wrapper); 
                } else namesInput.innerHTML += `<div>${it.name}</div>`; 
            }); 
            syncFromVisual(); 
        }
        function toggleHide() { document.getElementById('mainControls').classList.toggle('hidden-mode', document.getElementById('hideArea').checked); }
        function switchTab(t) { const isE = t === 'entries'; namesInput.style.display = isE ? 'block' : 'none'; document.getElementById('entriesButtons').style.display = isE ? 'block' : 'none'; resultsList.style.display = isE ? 'none' : 'block'; document.getElementById('resultsButtons').style.display = isE ? 'none' : 'block'; document.getElementById('tabEntries').className = isE ? 'tab-item active' : 'tab-item'; document.getElementById('tabResults').className = isE ? 'tab-item' : 'tab-item active'; }
        function goToStep2(t) { activeTarget=t; document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='flex'; renderGallery(); }
        function renderGallery() { const g = document.getElementById('galleryGrid'); g.innerHTML=""; abstractImages.forEach(u=>{ const i=document.createElement('img'); i.src=u; i.className="gallery-item"; i.onclick=()=>{ document.querySelectorAll('.gallery-item').forEach(e=>e.classList.remove('selected')); i.classList.add('selected'); selectedGalleryUrl=u; }; g.appendChild(i); }); }
        function confirmGallerySelection() { if(!selectedGalleryUrl) return; const i=new Image(); i.crossOrigin="anonymous"; i.onload=()=>{ applyImageData(i,selectedGalleryUrl); closeModals(); }; i.src=selectedGalleryUrl; }
        function applyImageData(i,u) { if(activeTarget==='bg') wheelBg=i; else if(activeTarget==='center') centerLogo=i; else { const w=document.createElement('div'); const li=document.createElement('img'); li.src=u; li.className="list-img"; w.appendChild(li); namesInput.appendChild(w); syncFromVisual(); } drawWheel(); }
        function triggerFileUpload() { document.getElementById('fileInput').click(); }
        document.getElementById('fileInput').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=(ev)=>{ const i=new Image(); i.onload=()=>{ applyImageData(i,ev.target.result); closeModals(); }; i.src=ev.target.result; }; r.readAsDataURL(f); };
        function shuffleItems() { if(isSpinning) return; items.sort(()=>Math.random()-0.5); writeBack(); }
        function sortItems() { if(isSpinning) return; items.sort((a,b)=>(a.name||"Z").localeCompare(b.name||"Z")); writeBack(); }
        function clearResults() { resultsArr=[]; updateResultsUI(); }
        function closeModals() { document.getElementById('modalType').style.display='none'; document.getElementById('modalSource').style.display='none'; }
        function closeWin() { document.getElementById('winnerModal').style.display='none'; }

        syncFromVisual();
        startIdleSpin();
    </script>
</body>
</html>
